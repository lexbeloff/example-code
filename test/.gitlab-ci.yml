image: ubuntu
stages:
  - deploy-stage
deploy-stage:
  tags:
    - vs27
  stage: deploy-stage
  only:
    - stage
  cache:
    paths:
      - node_modules/
  artifacts:
    paths:
      - dist/
      - node_modules/
      - ./
    expire_in: 1 day
  script:
    - PROJECT_HOST=vs29.lifehacker.ru
    - DEPLOY_USER=deploy
    - echo $CI_PROJECT_NAME
    - DEPLOY_PATH=/srv/www/lifebeta.ru/htdocs/special/$CI_PROJECT_NAME
    - ssh -o "StrictHostKeyChecking=no" deploy@$PROJECT_HOST "mkdir -p $DEPLOY_PATH"
    - nvm use stable
    - yarn install
    - yarn build
    - rsync -avzu --no-perms --no-owner --no-group --omit-dir-times ./* $DEPLOY_USER@$PROJECT_HOST:$DEPLOY_PATH
